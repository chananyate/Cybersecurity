# User Authentication System with PHP and MySQL

This MD file describes the process of setting up a simple user authentication system. It covers:

## 1. Installing and Setting Up MySQL

### 1.1 Installing MySQL

#### Ubuntu/Debian Linux
```bash
sudo apt update
sudo apt install mysql-server
```
After installing, I secured the MySQL installation:
```bash
sudo mysql_secure_installation
```

### 1.2 Logging into MySQL

Opened a terminal and logged into MySQL:
```bash
sudo mysql -u root -p
```

## 2. Creating the Database and Table

### 2.1 Creating the Database

Inside the MySQL prompt, I created the database named `user_auth`:
```sql
CREATE DATABASE user_auth;
USE user_auth;
```

### 2.2 Creating the Users Table

I ran the following SQL command to create the `users` table:
```sql
CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20) NOT NULL
);
```
This table stores:
- **user_id**: A unique identifier (auto-incremented)
- **username**: The user's unique username
- **password_hash**: The hashed version of the user's password
- **phone_number**: The user's phone number

## 3. Creating a Dedicated MySQL User to Avoid Access Denied Errors

### The Problem

When running the PHP script with the built-in server (using `php -S localhost:8000`), an error occurred:
```
PHP Fatal error:  Uncaught PDOException: SQLSTATE[HY000] [1698] Access denied for user 'root'@'localhost' ...
```
This error happens because the root user is often configured to use Unix socket authentication instead than a password.

### The Solution

I create a dedicated MySQL user (`myuser`) with proper password authentication and granted it privileges on the `user_auth` database.

### Steps:

1. I exited MySQL:
   ```sql
   EXIT;
   ```

2. Logged in as root using sudo:
   ```bash
   sudo mysql -u root -p
   ```

3. Inside MySQL, ran:
   ```sql
   CREATE USER 'myuser'@'localhost' IDENTIFIED BY 'mypassword';
   GRANT ALL PRIVILEGES ON user_auth.* TO 'myuser'@'localhost';
   FLUSH PRIVILEGES;
   EXIT;
   ```

## 4. Installing PHP and Running the Built-in Server

### 4.1 Installing PHP

PHP was not installed, so I ran:
```bash
sudo apt update
sudo apt install php-cli php-mysql
```

### 4.2 Running the PHP Built-in Server

1. Created a project directory:
   ```bash
   mkdir ~/Downloads/my_php_project
   cd ~/Downloads/my_php_project
   ```

2. Placed all PHP scripts in this folder.

3. Started the server:
   ```bash
   php -S localhost:8000
   ```

## 5. User Registration: Inserting a User into the Database

### 5.1 The `register.php` Script (Original Version)

```php
<?php
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

$pdo = new PDO("mysql:host=localhost;dbname=user_auth", "myuser", "mypassword");
$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$username = "testuser";
$password = "securepassword";
$phone_number = "1234567890";

$password_hash = password_hash($password, PASSWORD_DEFAULT);

/* Inserted the user into the database */
$stmt = $pdo->prepare("INSERT INTO users (username, password_hash, phone_number) VALUES (?, ?, ?)");
$stmt->execute([$username, $password_hash, $phone_number]);

echo "User registered!";
?>
```

### 5.2 Testing Registration

1. Run the PHP server (if not already running):
   ```bash
   php -S localhost:8000
   ```

2. Visited `http://localhost:8000/register.php`

3. Verified the insertion in MySQL:
   ```sql
   USE user_auth;
   SELECT * FROM users;
   ```
4. ```output
    +---------+----------+--------------------------------------------------------------+--------------+
    | user_id | username | password_hash                                                | phone_number |
    +---------+----------+--------------------------------------------------------------+--------------+
    |       1 | testuser | $2y$10$1boF0Z3n.Cu.FRgWE52wduNU8VBC8fW3y8Q4V5J26tuohldZ1klB6 | 1234567890   |
    +---------+----------+--------------------------------------------------------------+--------------+
    ```

## 6. Creating the Login System with 30-Minute Session Persistence

### 6.1 The Login Page (`login.php`)

```php
<?php
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    try {
        /* Connected using the dedicated MySQL user */
        $pdo = new PDO("mysql:host=localhost;dbname=user_auth", "myuser", "mypassword");
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        $username = $_POST["username"];
        $password = $_POST["password"];

        / * Retrieved user details */
        $stmt = $pdo->prepare("SELECT password_hash, phone_number FROM users WHERE username = ?");
        $stmt->execute([$username]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);

        if ($user && password_verify($password, $user["password_hash"])) {
            /* Set session and cookie (30 minutes) */
            $_SESSION["user"] = $username;
            setcookie("remember_user", $username, time() + 1800, "/", "", false, true);

            echo "Login successful! Your phone number is: " . htmlspecialchars($user["phone_number"]);
        } else {
            echo "Invalid username or password.";
        }
    } catch (PDOException $e) {
        die("Database error: " . $e->getMessage());
    }
}
?>

<!-- Simple HTML form for login -->
<form method="POST" action="">
    <label>Username:</label> <input type="text" name="username"><br>
    <label>Password:</label> <input type="password" name="password"><br>
    <button type="submit">Login</button>
</form>
```

### 6.2 The Authentication Check Page (`auth_check.php`)

```php
<?php
session_start();

if (isset($_SESSION["user"])) {
    echo "Welcome back, " . htmlspecialchars($_SESSION["user"]) . "!";
} elseif (isset($_COOKIE["remember_user"])) {
    /* Restore session from cookie if necessary */
    $_SESSION["user"] = $_COOKIE["remember_user"];
    echo "Welcome back, " . htmlspecialchars($_SESSION["user"]) . "!";
} else {
    echo "Please log in.";
}
?>
```

## 7. Modifying the `register.php` File for Session Checking

### Modified `register.php`

```php
<?php
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

/* Check if the user is already logged in */
if (isset($_SESSION["user"])) {
    echo "Welcome back, " . htmlspecialchars($_SESSION["user"]) . "!";
} elseif (isset($_COOKIE["remember_user"])) {
    /* If cookie exists, this restores session */
    $_SESSION["user"] = $_COOKIE["remember_user"];
    echo "Welcome back, " . htmlspecialchars($_SESSION["user"]) . "!";
} else {
    echo "You need to log in first.";
}
?>

<!-- Your registration form (if you want) -->
<form method="POST" action="register.php">
    <!-- Registration form fields -->
    <input type="text" name="username" placeholder="Username">
    <input type="password" name="password" placeholder="Password">
    <input type="text" name="phone_number" placeholder="Phone Number">
    <button type="submit">Register</button>
</form>
```

### Why This Modification?

- **User Experience**: If a user is already logged in, there's no need to prompt them with the registration form again. Instead, we welcome them back and avoid unnecessary re-authentication.
- **Session Persistence**: By checking both the PHP session and the persistent cookie (`remember_user`), we ensure that if the user is within the 30-minute window, they are recognized and automatically logged in without needing to re-enter credentials.
- **Security**: The checks are performed at the beginning of the script, so any subsequent operations (like showing the registration form) are only performed if the user is not authenticated.


### 8. Testing Login and Session Persistence

1. Login:
   - Visited `http://localhost:8000/login.php`
   - Entered credentials:
     - Username: `testuser`
     - Password: `securepassword`

2. Checked Session Persistence:
   - Closed and reopened my browser within 30 minutes
   - Typed `http://localhost:8000/auth_check.php`
   - Output: "Welcome back, testuser!"
