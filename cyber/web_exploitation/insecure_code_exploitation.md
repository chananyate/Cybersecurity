
## **1. SQL Injection Vulnerability**
### **Insecure Code**
```php
$var = $_POST['var'];
mysql_query("SELECT * FROM sometable WHERE id = $var");
```
### **What's Wrong?**
- **SQL Injection:** The `$var` variable is taken directly from user input and inserted into the query without validation or escaping. Attackers can manipulate the SQL query.

### **Secure Fix: Use Prepared Statements**
```php
$var = $_POST['var'];
$mysqli = new mysqli("host", "user", "password", "database");

$stmt = $mysqli->prepare("SELECT * FROM sometable WHERE id = ?");
$stmt->bind_param("i", $var); // "i" indicates integer type
$stmt->execute();
$result = $stmt->get_result();
```

---

## **2. XSS & Local File Inclusion (LFI)**
### **Insecure Code**
```php
$var = $_GET['var'];
echo "<div>$var</div>\n";  // XSS vulnerability

$file = $_GET['file'];
include($file);  // LFI vulnerability
```
### **What's Wrong?**
1. **XSS (Cross-Site Scripting)** – Directly outputting user input allows attackers to inject JavaScript.
2. **LFI (Local File Inclusion)** – Including user-controlled files enables attacks like `/etc/passwd` leakage.

### **Secure Fix: Sanitize Input and Restrict File Inclusion**
```php
$var = htmlspecialchars($_GET['var'], ENT_QUOTES, 'UTF-8'); // Prevent XSS
echo "<div>$var</div>\n";

// Secure file inclusion
$allowed_files = ['file1.php', 'file2.php'];
$file = $_GET['file'];

if (in_array($file, $allowed_files)) {
    include($file);
} else {
    die("Access denied.");
}
```

---

## **3. Broken Password Handling & SQL Injection**
### **Insecure Code**
```php
$message = "";
if (isset($_REQUEST["action"]) && isset($_REQUEST["password_new"]) && isset) { // Syntax error!
    $password_new = $_REQUEST["password_new"];
    $password_conf = $_REQUEST["password_conf"];

    if ($password_new == "") {
        $message = "<font color=\"red\">Please enter a new password...</font>";
    } else {
        if ($password_new != $password_conf) {
            $message = "<font color=\"red\">The passwords don't match!</font>";
        } else {
            $login = $_SESSION["login"];
            $password_new = mysqli_real_escape_string($link, $password_new);
            $password_new = hash("sha1", $password_new, false); // Weak hashing

            if (isset($_REQUEST["password_curr"])) {
                $password_curr = $_REQUEST["password_curr"];
            }

            $password_curr = mysqli_real_escape_string($link, $password_curr);
            $password_curr = hash("sha1", $password_curr, false);

            $sql = "SELECT password FROM users WHERE login = '" . $login . "'";
            $recordset = $link->query($sql);

            if (!$recordset) {
                die("Connect Error: " . $link->error);
            }

            $row = $recordset->fetch_object();
            if ($row) {
                $sql = "UPDATE users SET password = '" . $password_new . "' WHERE login = '" . $login . "'";
                $recordset = $link->query($sql);

                if (!$recordset) {
                    die("Connect Error: " . $link->error);
                }

                $message = "<font color=\"green\">The password has been changed.</font>";
            } else {
                $message = "<font color=\"red\">The current password is incorrect.</font>";
            }
        }
    }
}
```

### **What's Wrong?**
1. **SQL Injection** – `$login` and `$password_new` are inserted directly into SQL.
2. **Weak Password Hashing** – Uses `hash("sha1", ...)`, which is outdated.
3. **Plaintext Password Handling** – Passwords should never be processed in plaintext.

### **Secure Fix: Use Password Hashing and Prepared Statements**
```php
session_start();
require 'config.php'; // Database connection file
$message = "";

if (isset($_POST["action"]) && isset($_POST["password_new"]) && isset($_POST["password_conf"])) {
    $password_new = $_POST["password_new"];
    $password_conf = $_POST["password_conf"];

    if (empty($password_new)) {
        $message = "<font color='red'>Please enter a new password...</font>";
    } elseif ($password_new !== $password_conf) {
        $message = "<font color='red'>The passwords don't match!</font>";
    } else {
        $login = $_SESSION["login"];
        $password_new_hashed = password_hash($password_new, PASSWORD_BCRYPT); // Secure hashing

        $stmt = $link->prepare("SELECT password FROM users WHERE login = ?");
        $stmt->bind_param("s", $login);
        $stmt->execute();
        $stmt->store_result();

        if ($stmt->num_rows > 0) {
            $stmt->bind_result($hashed_password);
            $stmt->fetch();

            if (isset($_POST["password_curr"])) {
                $password_curr = $_POST["password_curr"];
                if (!password_verify($password_curr, $hashed_password)) {
                    $message = "<font color='red'>The current password is incorrect.</font>";
                } else {
                    $stmt = $link->prepare("UPDATE users SET password = ? WHERE login = ?");
                    $stmt->bind_param("ss", $password_new_hashed, $login);
                    $stmt->execute();
                    $message = "<font color='green'>The password has been changed.</font>";
                }
            }
        } else {
            $message = "<font color='red'>User not found.</font>";
        }
    }
}
```


