# Malware Analysis Report: Unknown.exe

## Analysis Overview

This report covers the analysis of the `Unknown.exe` sample. We performed both **static** and **dynamic** analysis to understand the sample's behavior, persistence mechanisms, and capabilities.

### Sample Information:
- **Operating System**: Windows WiselAMP64, 64-Lit Consciel
- **Linker**: Microsoft Linker (14.32.31332)
- **Compiler**: Microsoft Visual C/C++ (19.32.31332) [LTCG/C++]
- **Language**: C++
- **Library**: Microsoft C/C++ Runtime (dynamic)
- **Tool**: Visual Studio (2022, v17.2)
- **Debug Data**: 
  - Binary | Offset=0x1bdc, Size= 0x58
  - PDB File Link (7,0) Hash MD5: `4c169278d0e4ee7d0b9f2e011e47ed62`
  - Hash SHA-256: `f6a5419ee1465623e60ead9445df69d76dd08136a1e97315fb35d3e252b73d23`

## Static Analysis (Stage 1)

### 1. **Source Code Retrieval**:
   - We performed **static analysis** on the sample, which involved disassembling it using **IDA Pro** to retrieve the source code.
   - The static analysis revealed the key parts of the executable's logic, which involves downloading additional payloads, executing them, and creating persistence via the registry.

### 2. **Disassembly Findings**:
   - During static analysis, the following behavior was observed:
     - The malware attempts to download a file from a remote server using the `URLDownloadToFileA` function.
     - It then runs the downloaded file (`tempting.exe`) using `ShellExecuteA`.
     - The sample creates a registry key in `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run` to ensure that the malware is executed on startup.

   The static analysis provided insight into the overall **persistence** and **payload delivery** mechanisms of the sample.

## Dynamic Analysis (Stage 2)

### 1. **Process Monitor Findings**:
   During the **dynamic analysis** stage, we monitored the `Unknown.exe` sample using **Process Monitor** (ProcMon) to observe its behavior in real-time. The following registry modifications were made by the malware:

   - **Persistence Mechanisms**:
     - The malware added entries to the registry under:
       - `HKLM\System\CurrentControlSet\Services\bam\State\UserSettings\S-1-5-21-2340500993-2581104972-1404081054-1001\\Device\HarddiskVolume2\Windows\System32\conhost.exe`
       - `HKLM\System\CurrentControlSet\Services\bam\State\UserSettings\S-1-5-21-2340500993-2581104972-1404081054-1001\\Device\HarddiskVolume2\Users\User\Downloads\Unknown.exe`
     - These modifications are related to creating persistence by associating the malware with critical system paths.
     
   - **Network Settings**:
     - The sample modified registry entries under `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap`, altering network behavior by bypassing proxy settings and adjusting how the system handles intranet connections. This suggests the malware may need to communicate with external servers for further instructions or data exfiltration.

   - **Cache and Cookies**:
     - The malware also modified cache and cookie-related settings in the registry, which could indicate an attempt to track user activity or store data used in its operation.

   These findings provide more evidence of the malware's ability to persist on the system, manipulate network settings, and potentially track user behavior.

### 2. **New Discoveries**:
   - We observed the following actions in ProcMon:
     - The sample set various values in the registry, particularly under `Internet Settings` to influence network traffic routing and potentially avoid detection.
     - It made modifications to the **cmd.exe** registry entry, likely for spawning processes or maintaining control over system activity.
     - It interacted with `conhost.exe`, a common Windows system process, which might be part of its technique to blend in with legitimate processes and avoid detection.

## Summary of Findings

- **Static Analysis**:
  - The malware downloads additional payloads and executes them, likely using the `ShellExecuteA` function.
  - It creates persistence by modifying registry entries, ensuring it executes at startup.

- **Dynamic Analysis**:
  - The malware creates registry entries to ensure it persists and manipulates network settings to ensure communication with a command and control server.
  - It also attempts to hide its activity by modifying cache and cookies and interacting with system processes like `conhost.exe`.

### Next Steps:
1. **Investigate Network Traffic**: Capture any outbound traffic generated by the sample to identify external communication (C&C server URLs).
2. **Upload to VirusTotal**: Upload the sample for a more comprehensive analysis and to verify its detection across multiple AV engines.
3. **Observe Payload Execution**: Analyze the downloaded payload (`tempting.exe`) for further malicious activity.

## Answers to Exercise Questions:

### 1. **What are the sample's hashes?**
   - **MD5 Hash**: `4c169278d0e4ee7d0b9f2e011e47ed62`
   - **SHA-256 Hash**: `f6a5419ee1465623e60ead9445df69d76dd08136a1e97315fb35d3e252b73d23`

### 2. **What is the architecture of the sample?**
   - The sample is designed for a **64-bit architecture**, as indicated by its environment (Windows WiselAMP64, 64-Lit Consciel).

### 3. **What language was the sample written in? How do you know?**
   - The sample was written in **C++**. This was determined by examining the static analysis, which revealed the use of libraries and functions typically associated with C++ (e.g., `ShellExecuteA`, `URLDownloadToFileA`), as well as the use of the **Microsoft Visual C++** compiler.

### 4. **Does the sample persist? If so, how?**
   - Yes, the sample creates persistence. It does so by modifying the Windows registry to ensure it runs automatically on startup. Specifically, it adds an entry in the `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run` registry key.

### 5. **What does the sample do? What capabilities does it have?**
   - The sample attempts to download a second-stage payload (`tempting.exe`) from a remote server and execute it.
   - It creates persistence by modifying registry keys.
   - It interacts with network settings to potentially bypass proxies and facilitate communication with external servers.
   - It may be capable of tracking user activity or exfiltrating data, as suggested by the registry modifications related to cache and cookies.

### 6. **What evidence would you look for to detect this sample on a machine?**
   - Evidence of registry modifications, particularly under:
     - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`
     - `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap`
   - The presence of unusual executables in `C:\Program Files\` or the `Downloads` folder, such as `tempting.exe` or `Unknown.exe`.
   - Network traffic to unknown IP addresses or domains.
   - Interaction with system processes like `conhost.exe`.

### 7. **What URLs does this malware use?**
   - During static analysis, the sample attempts to download a file from the following URL:
     - `http://infinitylabs.local/f87sda6f87dsavgfd76gdfs87/f78sda678f/fj4938.exe`

## Conclusion

This analysis stage (both static and dynamic) has provided insight into the malware's behavior, persistence mechanisms, and capabilities. The next steps involve monitoring its network activity and further examining its payload.
